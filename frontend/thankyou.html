<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Confirmed ‚Äì Skyline Treats</title>
  <link rel="stylesheet" href="main.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <script>window.API_BASE = "http://localhost:8000/api";</script>
  <style>
    .ty-page { min-height:100vh; background:var(--bg); padding-top:64px; display:flex; flex-direction:column; }
    .ty-hero { background:var(--dark); padding:64px 40px 56px; text-align:center; position:relative; overflow:hidden; }
    .ty-hero::before { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:500px; height:300px; background:radial-gradient(ellipse,rgba(245,197,24,.13) 0%,transparent 70%); pointer-events:none; }
    .checkmark-circle { width:72px; height:72px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px; font-size:2rem; animation:popIn .5s cubic-bezier(.175,.885,.32,1.275) both; position:relative; }
    @keyframes popIn { from{opacity:0;transform:scale(.4)} to{opacity:1;transform:scale(1)} }
    @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
    .ty-hero h1 { font-family:'Playfair Display',serif; font-size:clamp(1.8rem,3vw,2.6rem); color:var(--white); margin-bottom:10px; animation:fadeUp .5s .15s ease both; position:relative; }
    .ty-hero p  { color:#999; font-size:1rem; animation:fadeUp .5s .25s ease both; position:relative; }
    .ty-total-badge { display:inline-block; background:rgba(245,197,24,.15); border:1px solid rgba(245,197,24,.35); color:var(--accent); font-weight:700; font-size:1.1rem; padding:10px 28px; border-radius:30px; margin-top:18px; animation:fadeUp .5s .35s ease both; position:relative; }
    .ty-body { flex:1; max-width:760px; width:100%; margin:0 auto; padding:48px 24px 64px; animation:fadeUp .5s .3s ease both; }
    .ty-card { background:var(--white); border:1px solid var(--border); border-radius:16px; padding:32px; margin-bottom:24px; }
    .ty-card-title { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; color:var(--dark); margin-bottom:24px; }
    .pay-tabs { display:flex; background:#f0f0ee; border-radius:10px; padding:4px; margin-bottom:28px; }
    .pay-tab { flex:1; padding:11px 10px; border:none; background:transparent; border-radius:8px; font-family:'DM Sans',sans-serif; font-size:.88rem; font-weight:600; color:var(--text-muted); cursor:pointer; transition:all .2s; }
    .pay-tab.active { background:var(--white); color:var(--dark); box-shadow:0 1px 5px rgba(0,0,0,.1); }
    .pay-panel { display:none; } .pay-panel.active { display:block; }
    .form-group { margin-bottom:16px; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    label { display:block; font-size:.78rem; font-weight:700; text-transform:uppercase; letter-spacing:.6px; color:var(--text-muted); margin-bottom:6px; }
    input,select { width:100%; padding:12px 14px; border:1.5px solid var(--border); border-radius:var(--radius); font-family:'DM Sans',sans-serif; font-size:.95rem; color:var(--text); background:var(--white); outline:none; transition:border-color .2s,box-shadow .2s; -webkit-appearance:none; }
    input::placeholder { color:#ccc; }
    input:focus,select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(245,197,24,.15); }
    .pay-btn { width:100%; padding:14px; background:var(--dark); color:var(--white); border:none; border-radius:var(--radius); font-family:'DM Sans',sans-serif; font-size:.95rem; font-weight:700; cursor:pointer; margin-top:8px; transition:background .2s,transform .15s; }
    .pay-btn:hover { background:var(--mid); transform:translateY(-1px); }
    .pay-btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }
    .pay-result { border-radius:10px; padding:14px 18px; font-size:.9rem; font-weight:500; margin-top:14px; display:none; }
    .pay-result.success { background:#f0fff4; border:1px solid #bbf7d0; color:#166534; }
    .pay-result.error   { background:#fff0f0; border:1px solid #fecaca; color:#991b1b; }
    .back-row { text-align:center; margin-top:8px; }
    .back-link { display:inline-flex; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; font-size:.9rem; font-weight:500; padding:10px 20px; border:1.5px solid var(--border); border-radius:30px; background:var(--white); transition:all .2s; }
    .back-link:hover { border-color:var(--dark); color:var(--dark); }
    .footer { background:var(--dark2); padding:32px 40px; margin-top:auto; }
    .footer-bottom { max-width:1160px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }
    .footer-bottom p { color:#444; font-size:.85rem; }
    .footer-bottom a { color:#555; font-size:.85rem; text-decoration:none; margin-left:16px; }
    .footer-bottom a:hover { color:var(--accent); }
    @media(max-width:600px){ .form-row{grid-template-columns:1fr;} .ty-hero{padding:48px 20px 44px;} .ty-body{padding:32px 16px 48px;} }
  </style>
</head>
<body>

  <header class="navbar">
    <a href="dashboard.html" class="logo">Skyline Treats</a>
    <nav class="nav-links" id="nav">
      <a href="home.html">Home</a>
      <a href="aboutus.html">About</a>
      <a href="contactus.html">Contact</a>
      <a href="faq.html">FAQ</a>
      <a href="profile.html">Profile</a>
      <a href="#" id="signoutBtn" class="signout">Sign Out</a>
    </nav>
    <div class="nav-right">
      <div class="menu-toggle" id="toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
    </div>
  </header>

  <div class="ty-page">
    <div class="ty-hero">
      <div class="checkmark-circle">‚úì</div>
      <h1>Order Confirmed!</h1>
      <p>Thank you for ordering with Skyline Treats. Please complete your payment below.</p>
      <div class="ty-total-badge" id="total-badge">Loading‚Ä¶</div>
    </div>

    <div class="ty-body">
      <div class="ty-card">
        <div class="ty-card-title">üí≥ Complete Payment</div>
        <div class="pay-tabs">
          <button class="pay-tab active" data-tab="mpesa">üì± M-Pesa</button>
          <button class="pay-tab"        data-tab="visa">üí≥ Card</button>
          <button class="pay-tab"        data-tab="crypto">‚Çø Crypto</button>
        </div>

        <!-- M-Pesa -->
        <div class="pay-panel active" id="panel-mpesa">
          <div class="form-group">
            <label for="mpesa-phone">M-Pesa Phone Number</label>
            <input type="tel" id="mpesa-phone" placeholder="e.g. 0712 345 678" maxlength="13" />
          </div>
          <button class="pay-btn" style="background:var(--accent);color:var(--dark);" onclick="processPayment('M-Pesa')">‚úì Pay with M-Pesa</button>
          <div class="pay-result" id="result-mpesa"></div>
        </div>

        <!-- Card -->
        <div class="pay-panel" id="panel-visa">
          <div class="form-group">
            <label for="card-number">Card Number</label>
            <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19" />
          </div>
          <div class="form-row">
            <div class="form-group"><label for="expiry">Expiry</label><input type="text" id="expiry" placeholder="MM / YY" maxlength="7" /></div>
            <div class="form-group"><label for="cvv">CVV</label><input type="text" id="cvv" placeholder="‚Ä¢‚Ä¢‚Ä¢" maxlength="4" /></div>
          </div>
          <div class="form-group">
            <label for="cardholder">Cardholder Name</label>
            <input type="text" id="cardholder" placeholder="As on card" />
          </div>
          <button class="pay-btn" onclick="processPayment('Card')">üîí Pay Securely</button>
          <div class="pay-result" id="result-visa"></div>
        </div>

        <!-- Crypto -->
        <div class="pay-panel" id="panel-crypto">
          <div class="form-group">
            <label for="crypto-type">Cryptocurrency</label>
            <select id="crypto-type"><option value="BTC">Bitcoin (BTC)</option><option value="ETH">Ethereum (ETH)</option><option value="USDT">Tether (USDT)</option></select>
          </div>
          <div class="form-group">
            <label for="wallet">Your Wallet Address</label>
            <input type="text" id="wallet" placeholder="Paste wallet address" />
          </div>
          <button class="pay-btn" onclick="processPayment('Crypto')">‚Çø Pay with Crypto</button>
          <div class="pay-result" id="result-crypto"></div>
        </div>
      </div>

      <div class="back-row"><a href="dashboard.html" class="back-link">‚Üê Back to Menu</a></div>
    </div>

    <footer class="footer">
      <div class="footer-bottom">
        <p>¬© 2026 Skyline Treats. All rights reserved.</p>
        <div><a href="faq.html">FAQ</a><a href="contactus.html">Contact</a></div>
      </div>
    </footer>
  </div>

  <script>
    const API = window.API_BASE || "http://localhost:8000/api";
    const total   = localStorage.getItem("last_order_total");
    const orderId = localStorage.getItem("last_order_id");

    document.getElementById("total-badge").textContent =
      total ? `Order Total: KSH ${parseFloat(total).toFixed(2)}` : "Order Placed";

    // Tabs
    document.querySelectorAll(".pay-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".pay-tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".pay-panel").forEach(p => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById("panel-" + tab.dataset.tab).classList.add("active");
      });
    });

    // Nav
    document.getElementById("toggle").addEventListener("click", e => {
      e.stopPropagation();
      document.getElementById("nav").classList.toggle("active");
    });
    document.getElementById("signoutBtn").addEventListener("click", e => {
      e.preventDefault();
      localStorage.removeItem("st_token");
      localStorage.removeItem("st_user");
      window.location.href = "auth.html";
    });

    // Card formatting
    document.getElementById("card-number").addEventListener("input", function () {
      let v = this.value.replace(/\D/g,"").substring(0,16);
      this.value = v.replace(/(.{4})/g,"$1 ").trim();
    });
    document.getElementById("expiry").addEventListener("input", function () {
      let v = this.value.replace(/\D/g,"").substring(0,4);
      if (v.length >= 3) v = v.slice(0,2) + " / " + v.slice(2);
      this.value = v;
    });

    async function processPayment(method) {
      if (!total) { showResult(method, "error", "No order total found."); return; }
      if (!confirm(`Confirm payment of KSH ${parseFloat(total).toFixed(2)} via ${method}?`)) return;

      // Validation
      if (method === "M-Pesa" && !document.getElementById("mpesa-phone").value.trim())
        { showResult(method, "error", "Please enter your M-Pesa number."); return; }
      if (method === "Card") {
        if (!document.getElementById("card-number").value.trim() ||
            !document.getElementById("expiry").value.trim() ||
            !document.getElementById("cvv").value.trim())
          { showResult(method, "error", "Please fill in all card details."); return; }
      }
      if (method === "Crypto" && !document.getElementById("wallet").value.trim())
        { showResult(method, "error", "Please enter your wallet address."); return; }

      const reference = method === "M-Pesa" ? document.getElementById("mpesa-phone").value.trim()
                      : method === "Crypto" ? document.getElementById("wallet").value.trim()
                      : null;

      try {
        const res  = await fetch(`${API}/payments/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("st_token")}`,
          },
          body: JSON.stringify({
            order_id:  parseInt(orderId),
            method:    method,
            amount:    parseFloat(total),
            reference: reference,
          }),
        });
        const data = await res.json();
        if (data.success) {
          showResult(method, "success", `‚úì Payment of KSH ${parseFloat(total).toFixed(2)} confirmed! Thank you.`);
          localStorage.removeItem("last_order_id");
          localStorage.removeItem("last_order_total");
          document.getElementById("total-badge").textContent = "‚úì Payment Complete";
        } else {
          showResult(method, "error", data.detail || data.error || "Payment failed.");
        }
      } catch {
        showResult(method, "error", "Could not connect to server. Please try again.");
      }
    }

    function showResult(method, type, msg) {
      const map = { "M-Pesa": "mpesa", "Card": "visa", "Crypto": "crypto" };
      const el  = document.getElementById("result-" + map[method]);
      if (!el) return;
      el.className = "pay-result " + type;
      el.textContent = msg;
      el.style.display = "block";
      el.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
  </script>
</body>
</html>
