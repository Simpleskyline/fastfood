<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password – Skyline Treats</title>
  <link rel="stylesheet" href="auth.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
</head>
<body>
  <header class="navbar">
    <a href="home.html" class="logo">Skyline Treats</a>
  </header>

  <div class="auth-page" style="justify-content:center;">
    <div class="form-panel" style="max-width:440px;">
      <div class="form-header">
        <h2 id="formTitle">Set New Password</h2>
        <p id="formSub">Enter your new password below.</p>
      </div>
      <div id="msgBox" style="display:none;padding:12px 16px;border-radius:10px;font-size:.9rem;margin-bottom:16px;"></div>
      <form id="resetForm" class="auth-form active" onsubmit="handleReset(event)">
        <div class="form-group">
          <label for="newPass">New Password</label>
          <input type="password" id="newPass" minlength="6" required placeholder="At least 6 characters"/>
        </div>
        <div class="form-group">
          <label for="confPass">Confirm Password</label>
          <input type="password" id="confPass" required placeholder="Repeat password"/>
        </div>
        <button type="submit" class="submit-btn" id="submitBtn">SET NEW PASSWORD</button>
      </form>
    </div>
  </div>

  <script>
    const API   = "http://localhost:8000/api";
    const token = new URLSearchParams(window.location.search).get('token');
    if (!token) {
      document.getElementById('formTitle').textContent = 'Invalid Link';
      document.getElementById('formSub').textContent   = 'This password reset link is invalid or expired.';
      document.getElementById('resetForm').style.display = 'none';
    }

    async function handleReset(e) {
      e.preventDefault();
      const pass = document.getElementById('newPass').value;
      const conf = document.getElementById('confPass').value;
      const btn  = document.getElementById('submitBtn');
      const msg  = document.getElementById('msgBox');

      if (pass !== conf) { showMsg('Passwords do not match.', 'error'); return; }
      btn.disabled = true; btn.textContent = 'Saving…';

      try {
        const res  = await fetch(`${API}/auth/reset-password`, {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ token, new_password: pass }),
        });
        const data = await res.json();
        if (data.success) {
          showMsg('✅ ' + data.message + ' Redirecting to sign in…', 'success');
          document.getElementById('resetForm').style.display = 'none';
          setTimeout(() => window.location.href = 'home.html', 2500);
        } else {
          showMsg(data.detail || data.error || 'Failed to reset password.', 'error');
        }
      } catch { showMsg('Server error. Please try again.', 'error'); }
      finally { btn.disabled = false; btn.textContent = 'SET NEW PASSWORD'; }
    }

    function showMsg(text, type) {
      const el = document.getElementById('msgBox');
      el.textContent = text;
      el.style.cssText = type === 'success'
        ? 'display:block;background:#d1fae5;border:1px solid #6ee7b7;color:#065f46;padding:12px 16px;border-radius:10px;font-size:.9rem;margin-bottom:16px;'
        : 'display:block;background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:12px 16px;border-radius:10px;font-size:.9rem;margin-bottom:16px;';
    }
  </script>
</body>
</html>
