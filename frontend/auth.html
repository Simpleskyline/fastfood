<!DOCTYPE html>
<html lang="en">

<head>
 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign In / Sign Up - Ron'z Pizza</title>
  <link rel="stylesheet" href="../assets/css/auth.css">
  
  <style>
    .hint { font-size: 0.9rem; color: #666; margin-top: 8px; }
    .loading { opacity: 0.6; pointer-events: none; }
    .error-text { color: #d32f2f; font-size: 0.9rem; margin-top: 5px; }
  </style>

</head>

<body class="auth">

  <div class="container">
    <div class="form-box">

        <!-- Sign In -->
        <form id="signinForm" class="auth-form signin">
        <h2>Sign In</h2>
        <div id="signinError" class="error-text" style="display:none;"></div>
        <input type="email" id="signinEmail" placeholder="Email" required autocomplete="email">
        <input type="password" id="signinPassword" placeholder="Password" required autocomplete="current-password">
        <a href="#" style="font-size: 0.9rem;">Forgot your password?</a><br><br>
        <button type="submit" id="signinBtn">SIGN IN</button>
      </form>

        <!-- Sign Up -->
        <form id="signupForm" class="auth-form signup" style="display:none;">
        <h2>Create Account</h2>
        <div id="signupError" class="error-text" style="display:none;"></div>
        <input type="text" id="firstName" placeholder="First Name" required autocomplete="given-name">
        <input type="text" id="lastName" placeholder="Last Name" required autocomplete="family-name">
        <input type="text" id="username" placeholder="Username" required autocomplete="username">
        <input type="email" id="email" placeholder="Email" required autocomplete="email">
        <input type="password" id="password" placeholder="Password" required autocomplete="new-password" minlength="6">
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required autocomplete="new-password">

        <!-- ROLE selection -->
        <label for="role">Register as</label>
        <select id="role" required>
          <option value="customer">Client</option>
          <option value="admin">Admin</option>
        </select>
        <button type="submit" id="signupBtn">SIGN UP</button>
      </form>
    </div>

    <div class="panel">
      <h2 id="panelTitle">Hello Friend!</h2>
      <p id="panelText">Enter your personal details and start your journey with us.</p>
      <button class="btn-outline" id="toggleBtn">SIGN UP</button>
    </div>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script>
    // Elements
    const signinForm = document.getElementById("signinForm");
    const signupForm = document.getElementById("signupForm");
    const toggleBtn = document.getElementById("toggleBtn");
    const signinBtn = document.getElementById("signinBtn");
    const signupBtn = document.getElementById("signupBtn");
    const signinError = document.getElementById("signinError");
    const signupError = document.getElementById("signupError");

    // Check if already logged in
    if (Auth.isLoggedIn()) {
      const user = Auth.getCurrentUser();
      window.location.href = user.role === 'admin' ? 'admin/admin_dashboard.html' : 'frontend/pages/dashboard.html';
    }

    // Toggle function
    function showSignup(show) {
      // Clear errors
      signinError.style.display = 'none';
      signupError.style.display = 'none';

      if (show) {
        signinForm.style.display = "none";
        signupForm.style.display = "block";
        toggleBtn.textContent = "SIGN IN";
        document.getElementById("panelTitle").textContent = "Welcome Back!";
        document.getElementById("panelText").textContent = "Create your account and choose your role.";
      } else {
        signinForm.style.display = "block";
        signupForm.style.display = "none";
        toggleBtn.textContent = "SIGN UP";
        document.getElementById("panelTitle").textContent = "Hello, Friend!";
        document.getElementById("panelText").textContent = "Enter your personal details and start your journey with us";
      }
    }

    // Initial state: sign in visible
    showSignup(false);

    // UI toggle
    toggleBtn.addEventListener("click", () => showSignup(signinForm.style.display !== "none"));

    // Show error message
    function showError(element, message) {
      element.innerHTML = message;
      element.style.display = 'block';
    }

    // Redirect based on role
    function redirectToDashboard(user) {
      if (user.role === "admin") {
        window.location.href = "admin/admin_dashboard.html";
      } else {
        window.location.href = "frontend/pages/dashboard.html";
      }
    }

    // --- SIGNUP handler ---
    signupForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      signupError.style.display = 'none';

      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      if (password !== confirmPassword) {
        showError(signupError, "Passwords do not match.");
        return;
      }

      if (password.length < 6) {
        showError(signupError, "Password must be at least 6 characters.");
        return;
      }

      // Basic email validation
      const email = document.getElementById("email").value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError(signupError, "Please enter a valid email address.");
        return;
      }

      // Disable button during submission
      signupBtn.disabled = true;
      signupBtn.textContent = 'Creating account...';

      const formData = new FormData();
      formData.append('FirstName', document.getElementById("firstName").value.trim());
      formData.append('LastName', document.getElementById("lastName").value.trim());
      formData.append('Username', document.getElementById("username").value.trim());
      formData.append('Email', document.getElementById("email").value.trim());
      formData.append('Password', password);
      formData.append('ConfirmPassword', confirmPassword);
      formData.append('Role', document.getElementById("role").value);

      fetch('http://localhost/fastfood/auth/submit_signup.php', {
  method: 'POST',
  body: formData,
  credentials: 'same-origin',
  headers: {
    'Accept': 'application/json'
  }
});
      try {
        console.log('Sending signup request...');

        console.log('Response status:', response.status);
        console.log('Response headers:', Object.fromEntries(response.headers.entries()));

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Server error response:', errorText);
          throw new Error(`Server returned ${response.status}: ${errorText}`);
        }

        // Get response text first to debug
        const responseText = await response.text();
        console.log('Response text:', responseText);

        // Try to parse JSON
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('JSON parse error:', jsonError);
          console.error('Response was:', responseText);
          throw new Error('Invalid response from server. Check console for details.');
        }
        
        if (data.success) {
          // Store user in localStorage for frontend auth
          const user = data.user;
          
          const users = JSON.parse(localStorage.getItem("fastfood_users") || "{}");
          users[user.username] = user;
          localStorage.setItem("fastfood_users", JSON.stringify(users));
          localStorage.setItem("fastfood_current", user.username);

          alert(data.message);
          redirectToDashboard(user);
        } else {
          showError(signupError, data.message || 'Registration failed. Please try again.');
        }
      } catch (error) {
        console.error('Signup error:', error);
        let errorMessage = 'An error occurred. Please try again.';
        
        try {
          // Try to parse the error response if it's JSON
          const errorData = JSON.parse(error.message.split(':').slice(1).join(':').trim());
          if (errorData.errors && Array.isArray(errorData.errors)) {
            // Show all validation errors
            errorMessage = errorData.errors.join('<br>');
          } else if (errorData.message) {
            errorMessage = errorData.message;
          }
        } catch (e) {
          // If we can't parse as JSON, use the original error message
          if (error.message.includes('Failed to fetch')) {
            errorMessage = 'Cannot connect to server. Please ensure XAMPP is running with Apache and MySQL started.';
          } else if (error.message.includes('NetworkError')) {
            errorMessage = 'Network error. Please check your internet connection.';
          } else if (error.message.includes('500')) {
            errorMessage = 'Server error. Please check the server logs for more details.';
          } else {
            errorMessage = error.message || errorMessage;
          }
        }
        
        signupError.innerHTML = errorMessage; // Use innerHTML to render <br> tags
      } finally {
        signupBtn.disabled = false;
        signupBtn.textContent = 'SIGN UP';
      }
    });

    // --- SIGNIN handler ---
    signinForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get form elements with proper null checks
      const emailInput = document.getElementById('signinEmail');
      const passwordInput = document.getElementById('signinPassword');
      
      if (!emailInput || !passwordInput) {
        console.error('Could not find email or password input fields');
        if (signinError) {
          signinError.textContent = 'Form fields not found. Please refresh the page.';
          signinError.style.display = 'block';
        }
        return;
      }
      
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      
      // Show loading state
      const submitBtn = signinForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Signing in...';
      
      // Clear any previous errors
      signinError.style.display = 'none';
      
      try {
        console.log('Sending login request...');
        const response = await fetch('http://localhost:8080/fastfood/auth/login.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          }),
          credentials: 'same-origin'  // Important for session cookies
        });
        
        console.log('Response status:', response.status);
        const responseText = await response.text();
        console.log('Raw response:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed response data:', data);
        } catch (e) {
          console.error('Failed to parse JSON:', e);
          console.error('Response headers:', Object.fromEntries(response.headers.entries()));
          throw new Error('Invalid JSON response from server: ' + responseText.substring(0, 200));
        }
        
        console.log('Parsed response:', data);
        
        if (data.success) {
          let userData = data.user || (data.data && data.data.user) || null;
          
          if (!userData) {
            console.error('No user data in response:', data);
            throw new Error('Invalid user data received from server');
          }
          
          // Ensure required fields exist
          if (!userData.Username || !userData.Role) {
            console.error('Missing required user fields:', userData);
            throw new Error('Incomplete user data received');
          }
          
          // Store user data in localStorage
          const userToStore = {
            id: userData.ID,
            username: userData.Username,
            email: userData.Email,
            role: userData.Role,
            firstName: userData.FirstName || '',
            lastName: userData.LastName || ''
          };
          
          localStorage.setItem('user', JSON.stringify(userToStore));
          
          // For backward compatibility
          const users = JSON.parse(localStorage.getItem('fastfood_users') || '{}');
          users[userToStore.username] = userToStore;
          localStorage.setItem('fastfood_users', JSON.stringify(users));
          localStorage.setItem('fastfood_current', userToStore.username);
          
          console.log('User data stored:', userToStore);
          
          // Determine redirect URL
          const redirectUrl = data.redirect || 
                            (data.data && data.data.redirect) || 
                            (userToStore.role === 'admin' ? 'aadmin/admin_dashboard.html' : 'frontend/pages/dashboard.html');
          
          console.log('Redirecting to:', redirectUrl);
          window.location.href = redirectUrl;
        } else {
          const errorMessage = data.message || data.error || 'Login failed. Please check your credentials.';
          showError(signinError, errorMessage);
        }
      } catch (error) {
        console.error('Login error:', error);
        const errorMessage = error.message || 'An error occurred. Please check your connection and try again.';
        showError(signinError, errorMessage);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  </script>

</body>
</html>