<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Ronz Pizza</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #EF4444;
      --secondary: #FDE047;
      --bg-light: #F9FAFB;
      --text-dark: #1F2937;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    h1 {
      color: var(--primary);
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2.5rem;
      font-weight: 800;
    }

    section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    h2 {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--secondary);
      padding-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary) 0%, #DC2626 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }

    .stat-card p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    
    thead th {
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 0.5rem;
      text-align: left;
      border: 1px solid #E5E7EB;
      font-weight: 600;
    }
    
    tbody tr:nth-child(even) {
      background-color: #F3F4F6;
    }

    tbody tr:hover {
      background-color: #FEE2E2;
      transition: background-color 0.2s;
    }

    tbody td {
      padding: 0.75rem 0.5rem;
      border: 1px solid #E5E7EB;
    }
    
    button {
      background-color: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.2s;
      margin-right: 0.5rem;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #DC2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background-color: #6B7280;
    }

    .btn-secondary:hover {
      background-color: #4B5563;
    }

    .btn-success {
      background-color: #10B981;
    }

    .btn-success:hover {
      background-color: #059669;
    }

    .action-btn-group button {
      margin: 0.25rem 0.25rem 0.25rem 0;
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    
    .status-pending { 
      background-color: #FEF3C7;
      color: #92400E;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-processing { 
      background-color: #DBEAFE;
      color: #1E40AF;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-completed { 
      background-color: #D1FAE5;
      color: #065F46;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-cancelled { 
      background-color: #FEE2E2;
      color: #991B1B;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .action-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .action-row select {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #D1D5DB;
      background-color: white;
      cursor: pointer;
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Modal Box */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      min-width: 400px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal h3 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--text-dark);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .search-filter {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .search-filter input {
      flex: 1;
      min-width: 200px;
      padding: 0.75rem;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6B7280;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6B7280;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 1rem;
      opacity: 0.3;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-admin {
      background-color: #DBEAFE;
      color: #1E40AF;
    }

    .badge-customer {
      background-color: #E0E7FF;
      color: #4338CA;
    }

    .order-details {
      font-size: 0.85rem;
      color: #6B7280;
      margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
      .modal {
        min-width: 90%;
        padding: 1.5rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.8rem;
      }

      thead th, tbody td {
        padding: 0.5rem 0.25rem;
      }
    }
  </style>
</head>

<body class="container">

  <h1>üçï Ronz Pizza Admin Dashboard</h1>

  <!-- Stats Overview -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3 id="totalClients">0</h3>
      <p>Total Clients</p>
    </div>
    <div class="stat-card">
      <h3 id="totalOrders">0</h3>
      <p>Total Orders</p>
    </div>
    <div class="stat-card">
      <h3 id="pendingOrders">0</h3>
      <p>Pending Orders</p>
    </div>
    <div class="stat-card">
      <h3 id="menuItems">0</h3>
      <p>Menu Items</p>
    </div>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>

  <!-- Add/Edit User Modal -->
  <div class="modal" id="userModal">
    <h3 id="userModalTitle">Add New Client</h3>
    <form id="userForm" onsubmit="handleUserSubmit(event)">
      <div class="form-group">
        <label for="firstName">First Name *</label>
        <input type="text" id="firstName" required>
      </div>
      <div class="form-group">
        <label for="lastName">Last Name *</label>
        <input type="text" id="lastName" required>
      </div>
      <div class="form-group">
        <label for="username">Username *</label>
        <input type="text" id="username" required>
      </div>
      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" required>
      </div>
      <div class="form-group">
        <label for="password">Password * (min 8 characters)</label>
        <input type="password" id="password" minlength="8" required>
      </div>
      <div class="form-group">
        <label for="role">Role *</label>
        <select id="role" required>
          <option value="customer">Customer</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn-success">Save Client</button>
      </div>
    </form>
  </div>

  <!-- Add/Edit Item Modal -->
  <div class="modal" id="itemModal">
    <h3 id="itemModalTitle">Add New Menu Item</h3>
    <form id="itemForm" onsubmit="handleItemSubmit(event)">
      <input type="hidden" id="itemId">
      <div class="form-group">
        <label for="itemName">Item Name *</label>
        <input type="text" id="itemName" required>
      </div>
      <div class="form-group">
        <label for="itemPrice">Price (Ksh) *</label>
        <input type="number" id="itemPrice" step="0.01" min="0" required>
      </div>
      <div class="form-group">
        <label for="itemAvailable">Availability *</label>
        <select id="itemAvailable" required>
          <option value="1">Available</option>
          <option value="0">Not Available</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn-success">Save Item</button>
      </div>
    </form>
  </div>

  <!-- Order Details Modal -->
  <div class="modal" id="orderModal">
    <h3>Order Details</h3>
    <div id="orderDetailsContent"></div>
    <div class="modal-actions">
      <button type="button" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Clients Section -->
  <section>
    <h2>
      <span>üë• Clients Management</span>
      <button onclick="showAddUserModal()">+ Add New Client</button>
    </h2>
    <div class="search-filter">
      <input type="text" id="userSearch" placeholder="Search clients by name or email..." oninput="filterUsers()">
    </div>
    <div id="usersLoading" class="loading">Loading clients...</div>
    <table class="min-w-full" id="usersTableWrapper" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Username</th>
          <th>Role</th>
          <th>Joined</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </section>

  <!-- Orders Section -->
  <section>
    <h2>
      <span>üì¶ Orders Management</span>
      <button onclick="loadOrders()">üîÑ Refresh</button>
    </h2>
    <div class="search-filter">
      <input type="text" id="orderSearch" placeholder="Search orders..." oninput="filterOrders()">
      <select id="statusFilter" onchange="filterOrders()">
        <option value="">All Statuses</option>
        <option value="Pending">Pending</option>
        <option value="Processing">Processing</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </div>
    <div id="ordersLoading" class="loading">Loading orders...</div>
    <table class="min-w-full" id="ordersTableWrapper" style="display: none;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Total (Ksh)</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTable"></tbody>
    </table>
  </section>

  <!-- Menu Items Section -->
  <section>
    <h2>
      <span>üçï Menu Items</span>
      <button onclick="showAddItemModal()">+ Add New Item</button>
    </h2>
    <div class="search-filter">
      <input type="text" id="itemSearch" placeholder="Search menu items..." oninput="filterItems()">
      <select id="availabilityFilter" onchange="filterItems()">
        <option value="">All Items</option>
        <option value="1">Available</option>
        <option value="0">Not Available</option>
      </select>
    </div>
    <div id="itemsLoading" class="loading">Loading menu items...</div>
    <table class="min-w-full" id="itemsTableWrapper" style="display: none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Price (Ksh)</th>
          <th>Available</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="itemsTable"></tbody>
    </table>
  </section>

  <script>
    const API_PATH = '../php/';
    
    let allUsers = [];
    let allOrders = [];
    let allItems = [];

    // Utility function for API calls
    async function apiCall(endpoint, method = 'GET', data = null) {
      const url = API_PATH + endpoint;
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      try {
        const res = await fetch(url, options);
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        const text = await res.text();
        if (!text) return { success: true, message: 'Action successful' };
        return JSON.parse(text);
      } catch (error) {
        console.error("API Call Error:", error);
        alert(`Network error: ${error.message}. Check console for details.`);
        return { success: false, message: `Network Error: ${error.message}` };
      }
    }

    // Modal Functions
    function showModal(modalId) {
      document.getElementById('modalOverlay').style.display = 'block';
      document.getElementById(modalId).style.display = 'block';
    }

    function closeModal() {
      document.getElementById('modalOverlay').style.display = 'none';
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
      document.getElementById('userForm').reset();
      document.getElementById('itemForm').reset();
    }

    // USER MANAGEMENT
    async function loadUsers() {
      document.getElementById('usersLoading').style.display = 'block';
      document.getElementById('usersTableWrapper').style.display = 'none';
      
      const result = await apiCall("get_users.php");
      const tbody = document.getElementById("usersTable");
      tbody.innerHTML = "";
      
      if (result.success && result.users) {
        allUsers = result.users;
        displayUsers(allUsers);
        document.getElementById('totalClients').textContent = allUsers.length;
      } else {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state">${result.message || 'Failed to load users.'}</td></tr>`;
      }
      
      document.getElementById('usersLoading').style.display = 'none';
      document.getElementById('usersTableWrapper').style.display = 'table';
    }

    function displayUsers(users) {
      const tbody = document.getElementById("usersTable");
      tbody.innerHTML = "";
      
      if (users.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          <p>No clients found</p>
        </td></tr>`;
        return;
      }
      
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.client_id}</td>
          <td>${u.First_Name} ${u.Last_Name}</td>
          <td>${u.Email}</td>
          <td>${u.Username || 'N/A'}</td>
          <td><span class="badge badge-${u.Role.toLowerCase()}">${u.Role}</span></td>
          <td>${new Date(u.created_at).toLocaleDateString()}</td>
          <td class="action-btn-group">
            <button onclick="deleteUser(${u.client_id}, '${u.First_Name} ${u.Last_Name}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterUsers() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const filtered = allUsers.filter(u => 
        u.First_Name.toLowerCase().includes(searchTerm) ||
        u.Last_Name.toLowerCase().includes(searchTerm) ||
        u.Email.toLowerCase().includes(searchTerm) ||
        (u.Username && u.Username.toLowerCase().includes(searchTerm))
      );
      displayUsers(filtered);
    }

    function showAddUserModal() {
      document.getElementById('userModalTitle').textContent = 'Add New Client';
      document.getElementById('userForm').reset();
      showModal('userModal');
    }

    async function handleUserSubmit(event) {
      event.preventDefault();
      
      const data = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        username: document.getElementById('username').value.trim(),
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value,
        role: document.getElementById('role').value
      };

      const result = await apiCall("add_user.php", "POST", data);
      
      if (result.success) {
        alert("Client added successfully!");
        closeModal();
        loadUsers();
      } else {
        alert(result.message || "Failed to add client");
      }
    }

    async function deleteUser(id, name) {
      if (!confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) return;
      
      const result = await apiCall("delete_user.php", "POST", { client_id: id });
      
      if (result.success) {
        alert(`${name} has been deleted successfully.`);
        loadUsers();
      } else {
        alert(result.message || "Failed to delete user");
      }
    }

    // ORDER MANAGEMENT
    async function loadOrders() {
      document.getElementById('ordersLoading').style.display = 'block';
      document.getElementById('ordersTableWrapper').style.display = 'none';
      
      const result = await apiCall("get_orders.php");
      const tbody = document.getElementById("ordersTable");
      tbody.innerHTML = "";
      
      if (result.success && result.orders) {
        allOrders = result.orders;
        displayOrders(allOrders);
        
        document.getElementById('totalOrders').textContent = allOrders.length;
        const pending = allOrders.filter(o => o.status === 'Pending').length;
        document.getElementById('pendingOrders').textContent = pending;
      } else {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">${result.message || 'Failed to load orders.'}</td></tr>`;
      }
      
      document.getElementById('ordersLoading').style.display = 'none';
      document.getElementById('ordersTableWrapper').style.display = 'table';
    }

    function displayOrders(orders) {
      const tbody = document.getElementById("ordersTable");
      tbody.innerHTML = "";
      const statusOptions = ['Pending', 'Processing', 'Completed', 'Cancelled'];
      
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
          <p>No orders found</p>
        </td></tr>`;
        return;
      }
      
      orders.forEach(o => {
        const tr = document.createElement("tr");
        const statusClass = `status-${o.status.toLowerCase()}`;
        const statusSelect = statusOptions.map(status => 
          `<option value="${status}" ${o.status === status ? 'selected' : ''}>${status}</option>`
        ).join('');

        tr.innerHTML = `
          <td><strong>#${o.order_id}</strong></td>
          <td>
            ${o.Username || 'Guest'}<br>
            <span class="order-details">ID: ${o.client_id}</span>
          </td>
          <td><strong>${Number(o.total).toFixed(2)}</strong></td>
          <td><span class="${statusClass}">${o.status}</span></td>
          <td>${new Date(o.created_at).toLocaleString()}</td>
          <td>
            <div class="action-row">
              <select id="status-${o.order_id}">${statusSelect}</select>
              <button class="btn-success" onclick="updateOrderStatus(${o.order_id}, document.getElementById('status-${o.order_id}').value)">Update</button>
              <button class="btn-secondary" onclick="viewOrderDetails(${o.order_id})">Details</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterOrders() {
      const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      
      const filtered = allOrders.filter(o => {
        const matchesSearch = 
          o.order_id.toString().includes(searchTerm) ||
          (o.Username && o.Username.toLowerCase().includes(searchTerm)) ||
          o.client_id.toString().includes(searchTerm);
        
        const matchesStatus = !statusFilter || o.status === statusFilter;
        
        return matchesSearch && matchesStatus;
      });
      
      displayOrders(filtered);
    }

    async function updateOrderStatus(orderId, newStatus) {
      const result = await apiCall("update_order_status.php", "POST", { 
        order_id: orderId, 
        status: newStatus 
      });
      
      if (result.success) {
        alert(`Order #${orderId} status updated to ${newStatus}`);
        loadOrders();
      } else {
        alert(result.message || "Failed to update order status");
      }
    }

    async function viewOrderDetails(orderId) {
      const order = allOrders.find(o => o.order_id === orderId);
      if (!order) return;
      
      const content = document.getElementById('orderDetailsContent');
      content.innerHTML = `
        <div class="form-group">
          <label>Order ID:</label>
          <p><strong>#${order.order_id}</strong></p>
        </div>
        <div class="form-group">
          <label>Customer:</label>
          <p>${order.Username || 'Guest'} (ID: ${order.client_id})</p>
        </div>
        <div class="form-group">
          <label>Total Amount:</label>
          <p><strong>Ksh ${Number(order.total).toFixed(2)}</strong></p>
        </div>
        <div class="form-group">
          <label>Status:</label>
          <p><span class="status-${order.status.toLowerCase()}">${order.status}</span></p>
        </div>
        <div class="form-group">
          <label>Order Date:</label>
          <p>${new Date(order.created_at).toLocaleString()}</p>
        </div>
      `;
      
      showModal('orderModal');
    }

    // MENU ITEM MANAGEMENT
    async function loadItems() {
      document.getElementById('itemsLoading').style.display = 'block';
      document.getElementById('itemsTableWrapper').style.display = 'none';
      
      const result = await apiCall("get_items.php");
      const tbody = document.getElementById("itemsTable");
      tbody.innerHTML = "";
      
      if (result.success && result.items) {
        allItems = result.items;
        displayItems(allItems);
        document.getElementById('menuItems').textContent = allItems.length;
      } else {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">${result.message || 'Failed to load menu items.'}</td></tr>`;
      }
      
      document.getElementById('itemsLoading').style.display = 'none';
      document.getElementById('itemsTableWrapper').style.display = 'table';
    }

    function displayItems(items) {
      const tbody = document.getElementById("itemsTable");
      tbody.innerHTML = "";
      
      if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          <p>No menu items found</p>
        </td></tr>`;
        return;
      }
      
      items.forEach(i => {
        const isAvailable = i.available == 1;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i.id}</td>
          <td><strong>${i.name}</strong></td>
          <td><strong>${Number(i.price).toFixed(2)}</strong></td>
          <td>${isAvailable ? '<span class="status-completed">Available</span>' : '<span class="status-cancelled">Unavailable</span>'}</td>
          <td class="action-btn-group">
            <button onclick="showEditItemModal(${i.id}, '${i.name.replace(/'/g, "\\'")}', ${i.price}, ${i.available})">Edit</button>
            <button onclick="deleteItem(${i.id}, '${i.name.replace(/'/g, "\\'")}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterItems() {
      const searchTerm = document.getElementById('itemSearch').value.toLowerCase();
      const availabilityFilter = document.getElementById('availabilityFilter').value;
      
      const filtered = allItems.filter(i => {
        const matchesSearch = i.name.toLowerCase().includes(searchTerm);
        const matchesAvailability = !availabilityFilter || i.available.toString() === availabilityFilter;
        return matchesSearch && matchesAvailability;
      });
      
      displayItems(filtered);
    }

    function showAddItemModal() {
      document.getElementById('itemModalTitle').textContent = 'Add New Menu Item';
      document.getElementById('itemForm').reset();
      document.getElementById('itemId').value = '';
      showModal('itemModal');
    }

    function showEditItemModal(id, name, price, available) {
      document.getElementById('itemModalTitle').textContent = 'Edit Menu Item';
      document.getElementById('itemId').value = id;
      document.getElementById('itemName').value = name;
      document.getElementById('itemPrice').value = price;
      document.getElementById('itemAvailable').value = available;
      showModal('itemModal');
    }

    async function handleItemSubmit(event) {
      event.preventDefault();
      
      const itemId = document.getElementById('itemId').value;
      const data = {
        name: document.getElementById('itemName').value.trim(),
        price: parseFloat(document.getElementById('itemPrice').value),
        available: parseInt(document.getElementById('itemAvailable').value)
      };

      let result;
      if (itemId) {
        data.id = parseInt(itemId);
        result = await apiCall("update_item.php", "POST", data);
      } else {
        result = await apiCall("add_item.php", "POST", data);
      }
      
      if (result.success) {
        alert(itemId ? "Menu item updated successfully!" : "Menu item added successfully!");
        closeModal();
        loadItems();
      } else {
        alert(result.message || "Failed to save menu item");
      }
    }

    async function deleteItem(id, name) {
      if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone.`)) return;
      
      const result = await apiCall("delete_item.php", "POST", { id });
      
      if (result.success) {
        alert(`"${name}" has been deleted successfully.`);
        loadItems();
      } else {
        alert(result.message || "Failed to delete item");
      }
    }

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
      loadUsers();
      loadOrders();
      loadItems();
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });
  </script>
</body>
</html>